!function n(e,r,t){function a(i,c){if(!r[i]){if(!e[i]){var d="function"==typeof require&&require;if(!c&&d)return d(i,!0);if(o)return o(i,!0);var l=new Error("Cannot find module '"+i+"'");throw l.code="MODULE_NOT_FOUND",l}var u=r[i]={exports:{}};e[i][0].call(u.exports,function(n){var r=e[i][1][n];return a(r||n)},u,u.exports,n,e,r,t)}return r[i].exports}for(var o="function"==typeof require&&require,i=0;i<t.length;i++)a(t[i]);return a}({1:[function(n,e,r){"use strict";function t(){T=L.map("map").setView(I["台南"],14),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"ching56.17hng6ja",accessToken:"pk.eyJ1IjoiY2hpbmc1NiIsImEiOiJjaXNiZmYydGMwMTN1MnpwbnNqNWVqM2plIn0.k7h-PUGX7Tl5xLwDH3Qpsg"}).addTo(T),$("#map").hide(),$("#map").fadeIn();var n=L.control({position:"bottomright"});n.onAdd=function(){var n=L.DomUtil.create("div","info legend"),e=[0,1,50,100,150,200];n.innerHTML+='<span class = "legend-header">捕獲數（個）<hr>';for(var r=0;r<e.length;r++)n.innerHTML+=0===e[r]?'<div class=" barrel_legend" id="grade_'+r+'"><i style="background:'+m(e[r])+'"></i>'+e[r]+"<br></div>":'<div class=" barrel_legend" id="grade_'+r+'"><i style="background:'+m(e[r])+'"></i>'+e[r]+(e[r+1]?" &ndash; "+(e[r+1]-1)+"<br></div>":" <br></div>");return n.innerHTML+='<div class=" barrel_legend" id="grade_other"><i style="background:#cccccc"></i>無資料<br></div>',n},n.addTo(T),$(".barrel_legend > input").on("click",function(){var n="."+$(this).val();$(this).prop("checked")?$(n).css("display","block"):$(n).css("display","none")})}function a(){var n=[],e={},r=moment($(".range-start").val()),t=moment($(".range-end").val()),a=g.slice().filter(function(n){var e=moment.tz(n.created_at,"Asia/Taipei");return e<=t&&e>=r});""!==r&&""!==t&&(D.forEach(function(e){var a=moment(e);a>=r&&a<=t&&n.push(a)}),n.forEach(function(n){var r=n.format("YYYY-MM-DD");e[r]=Y(r)}),o(e),l(a))}function o(n){var e=!(""===$(".range-start").val()),r=!(""===$(".range-end").val()),t=e?moment($(".range-start").val()).format("YYYY-MM-DD"):"未選擇起始日期",a=r?moment($(".range-end").val()).format("YYYY-MM-DD"):"未選擇結束日期",o={};if($(".map-container .list-group").empty(),u(),0===c(n).length){var l="沒有資料";r&&e||(l=""),d(t+" ~ "+a+" "+l)}else d(t+" ~ "+a+" 區間資料");for(var p in n){var f=n[p];for(var m in f)!function(n){var e=f[n],r=h.find(function(e){return e.lamp_id===n});i(k(r.place_id),r,e,p),o[r.lamp_id]||(o[r.lamp_id]={},o[r.lamp_id].lamp=r,o[r.lamp_id].count=0);var t=o[r.lamp_id].count;o[r.lamp_id].count=t+e}(m)}s(o),$("#map").fadeIn()}function i(n,e,r,t){var a='<a class="list-group-item ">\n        <h4 class="list-group-item-heading"><span>'+e.lamp_id+"@"+n+"</span><span>&#9889;"+r+'</span></h4>\n        <p class="list-group-item-text"> '+moment(t).format("LL")+"</p>\n      </a>";$(".map-container .list-group").append(a)}function c(n){try{return Object.keys(n)}catch(n){return[]}}function d(n){var e=$("<h3>"+n+"</h3>");$(".list-group").empty(),$(".list-group").append(e),e.hide(),e.fadeIn("slow")}function l(n){n.forEach(function(n){var e=[n.mcc_center[1],n.mcc_center[0]],r=b,t=L.circle(e,{radius:r});M.push(t),t.addTo(T)})}function u(){x.forEach(function(n){T.removeLayer(n)}),M.forEach(function(n){n.remove()}),M=[],$("#map").hide()}function s(n){for(var e in n){console.log(n);var r=n[e].lamp,t=n[e].count,a=r.lamp_location[1],o=r.lamp_location[0],i=L.icon({iconUrl:p(t),iconSize:[45,80],popupAnchor:[0,-40],iconAnchor:[22,60],className:f(t)}),c="<table>\n      <tr>\n        <th> ID </th>\n        <td> "+r.lamp_id+" </td>\n      </tr>\n      <tr>\n        <th>地點</th>\n        <td>"+k(r.place_id)+"</td>\n      </tr>\n        <tr>\n        <th>捕獲</th>\n        <td>"+t+"</td>\n      </tr>\n      </table>",d=L.marker([a,o],{icon:i}).bindPopup(c).addTo(T);x.push(d)}if(x.length>0){var l=new L.featureGroup(x);T.fitBounds(l.getBounds())}}function p(n){return"images/"+(0===n?"legend1":n>0&&n<=49?"legend2":n>=50&&n<=99?"legend3":n>=100&&n<=149?"legend4":n>=150&&n<=199?"legend5":n>=200?"legend6":"legend_undefined")+".svg"}function f(n){return 0===n?"grade_0":n>0&&n<=49?"grade_1":n>=50&&n<=99?"grade_2":n>=100&&n<=149?"grade_3":n>=150&&n<=199?"grade_4":n>=200?"grade_5":"grade_other"}function m(n){var e=void 0;return 0===n?e="#00FF9D":n>0&&n<=49?e="#33CC7E":n>=50&&n<=99?e="#66995E":n>=100&&n<=149?e="#99663F":n>=150&&n<=199?e="#CC331F":n>=200&&(e="#FF0000"),e}var v=function(){function n(n,e){var r=[],t=!0,a=!1,o=void 0;try{for(var i,c=n[Symbol.iterator]();!(t=(i=c.next()).done)&&(r.push(i.value),!e||r.length!==e);t=!0);}catch(n){a=!0,o=n}finally{try{!t&&c.return&&c.return()}finally{if(a)throw o}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return n(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=[],g=[],y=[],_=[],b=void 0,T=void 0,x=[],M=[],k=void 0,Y=void 0,D=void 0;moment.locale("zh-tw");var E=function(n){var e={};return n.forEach(function(n){e[n.place_id]=n.place_name}),function(n){return e[n]}},w=function(n){var e={};D.forEach(function(n){e[n]={}});for(var r in n){var t=n[r];for(var a in t)e[r][a]=+t[a].sum}return function(n){return e[n]}},I={"台南":[22.9971,120.1926],"高雄":[22.6397615,120.2999183],"屏東":[22.667431,120.486307]};$(document).ready(function(){d("資料載入中..."),$(".range-start").datepicker({autoclose:!0,zIndexOffset:1e3,format:"yyyy-mm-dd",disableTouchKeyboard:!0}).on("changeDate",a),$(".range-end").datepicker({autoclose:!0,zIndexOffset:1e3,format:"yyyy-mm-dd",disableTouchKeyboard:!0}).on("changeDate",a);var n=["lamps","rules","mcc","counts?formatBy=date","places"].map(function(n){return $.ajax({url:"http://140.116.249.228:3000/apis/"+n,dataType:"JSON",type:"GET"})});Promise.all(n).then(function(n){var e=void 0,r=v(n,5);h=r[0],e=r[1],g=r[2],y=r[3],_=r[4],b=e[0].distance_lower_limit,console.log(n),D=c(y),k=E(_),Y=w(y),t(),d("請選擇日期區間")}).catch(function(n){d("資料錯誤："+n.status+" "+n.statusText),console.log(n)})})},{}]},{},[1]);
//# sourceMappingURL=maps/app.js.map
